<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management - Aluma Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0f1c; color: #e2e8f0; display: flex; min-height: 100vh; }
        
        .sidebar { width: 250px; background: linear-gradient(180deg, #1a1f2e 0%, #141824 100%); padding: 20px 0; position: fixed; height: 100vh; border-right: 1px solid #2d3748; }
        .logo { padding: 0 20px 30px; border-bottom: 1px solid #2d3748; margin-bottom: 20px; }
        .logo h1 { font-size: 22px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .logo h1 i { color: #3b82f6; }
        .logo span { font-size: 12px; color: #64748b; display: block; margin-top: 5px; }
        .nav-menu { list-style: none; }
        .nav-item { margin: 5px 10px; }
        .nav-item a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #94a3b8; text-decoration: none; border-radius: 8px; transition: all 0.3s; }
        .nav-item a:hover { background: #2d3748; color: #fff; }
        .nav-item a.active { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); color: #fff; }
        .nav-item i { width: 20px; text-align: center; }
        .nav-section { padding: 15px 20px 10px; font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }

        .main { flex: 1; margin-left: 250px; padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h2 { font-size: 28px; font-weight: 600; }
        .header p { color: #64748b; margin-top: 5px; }
        .btn-logout { background: #dc2626; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }

        .search-box { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; border: 1px solid #2d3748; }
        .search-box input { flex: 1; min-width: 250px; padding: 12px 15px; background: #0a0f1c; border: 1px solid #2d3748; border-radius: 8px; color: #e2e8f0; font-size: 14px; }
        .search-box input:focus { outline: none; border-color: #3b82f6; }
        .search-box select { padding: 12px 15px; background: #0a0f1c; border: 1px solid #2d3748; border-radius: 8px; color: #e2e8f0; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }

        .card { background: #1e293b; border-radius: 12px; padding: 25px; border: 1px solid #2d3748; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #64748b; font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #2d3748; }
        td { padding: 15px 12px; border-bottom: 1px solid #2d3748; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 40px; height: 40px; border-radius: 10px; background: #3b82f6; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge.active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge.pending { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge.suspended { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .btn-sm { padding: 8px 15px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; border: 1px solid #2d3748; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 20px; }
        .modal-close { background: none; border: none; color: #64748b; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 25px; }

        .user-profile { display: flex; gap: 20px; padding: 20px; background: #0a0f1c; border-radius: 12px; margin-bottom: 25px; }
        .user-profile .avatar-lg { width: 70px; height: 70px; border-radius: 14px; background: #3b82f6; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; }
        .user-profile h4 { font-size: 22px; margin-bottom: 5px; }
        .user-profile p { color: #64748b; font-size: 14px; margin-bottom: 3px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 25px; border-bottom: 2px solid #2d3748; }
        .tab { padding: 12px 20px; background: none; border: none; color: #64748b; cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab:hover { color: #e2e8f0; }
        .tab.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .account-card { background: #0a0f1c; border: 1px solid #2d3748; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .account-card h4 { margin-bottom: 5px; }
        .account-card .account-num { color: #64748b; font-size: 13px; margin-bottom: 15px; }
        .account-card .balance { font-size: 32px; font-weight: 700; color: #22c55e; margin-bottom: 15px; }
        .account-card .meta { display: flex; gap: 20px; margin-bottom: 15px; font-size: 13px; color: #94a3b8; }
        .account-actions { display: flex; gap: 10px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: #0a0f1c; border: 1px solid #2d3748; border-radius: 8px; color: #e2e8f0; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .credit-debit-box { background: #0a0f1c; border: 2px solid #2d3748; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .credit-debit-box h5 { margin-bottom: 15px; font-size: 16px; }
        .credit-debit-box .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .credit-debit-box input { flex: 1; }
        .credit-debit-box .btn-row { display: flex; gap: 10px; }

        .loading { text-align: center; padding: 40px; color: #64748b; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid #22c55e; }
        .alert-error { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }

        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="logo"><h1><i class="fas fa-university"></i> Aluma</h1><span>Admin Portal</span></div>
        <div class="nav-section">Main</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="admin-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li class="nav-item"><a href="admin-account-management.html" class="active"><i class="fas fa-users"></i> Account Management</a></li>
            <li class="nav-item"><a href="#"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
        </ul>
        <div class="nav-section">Management</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="#"><i class="fas fa-id-card"></i> KYC Approvals</a></li>
            <li class="nav-item"><a href="#"><i class="fas fa-headset"></i> Support Tickets</a></li>
        </ul>
        <div class="nav-section">System</div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
            <li class="nav-item"><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <main class="main">
        <div class="header">
            <div><h2>Account Management</h2><p>Manage users, accounts, and balances</p></div>
            <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name or email...">
            <select id="statusFilter"><option value="">All Status</option><option value="active">Active</option><option value="pending">Pending</option><option value="suspended">Suspended</option></select>
            <button class="btn btn-primary" onclick="searchUsers()"><i class="fas fa-search"></i> Search</button>
        </div>

        <div class="card">
            <div id="usersTable"><div class="loading">Loading users...</div></div>
        </div>
    </main>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h3>User Details</h3><button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button></div>
            <div class="modal-body" id="modalBody"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script>
        var API = 'https://aluma-banking-backend.onrender.com/api/v1';
        var currentUserId = null;

        function getToken() { return localStorage.getItem('admin_access_token') || sessionStorage.getItem('admin_access_token'); }
        function getHeaders() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() }; }
        function checkAuth() { if (!getToken()) { window.location.href = 'admin-login.html'; return false; } return true; }
        function formatCurrency(amt) { return '$' + parseFloat(amt || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatDate(d) { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function logout() { localStorage.removeItem('admin_access_token'); localStorage.removeItem('admin_user'); window.location.href = 'admin-login.html'; }

        async function loadUsers() {
            try {
                var res = await fetch(API + '/admin/users?limit=50&sort_by=created_at&sort_order=DESC', { headers: getHeaders() });
                var data = await res.json();
                if (data.success) { renderUsers(data.data); } else { throw new Error(data.message); }
            } catch (e) { document.getElementById('usersTable').innerHTML = '<p style="color:#ef4444;text-align:center;padding:20px;">Failed to load users</p>'; }
        }

        async function searchUsers() {
            var search = document.getElementById('searchInput').value;
            var status = document.getElementById('statusFilter').value;
            var url = API + '/admin/users?limit=50';
            if (search) url += '&search=' + encodeURIComponent(search);
            if (status) url += '&status=' + status;
            try {
                var res = await fetch(url, { headers: getHeaders() });
                var data = await res.json();
                if (data.success) { renderUsers(data.data); }
            } catch (e) { console.error(e); }
        }

        function renderUsers(users) {
            if (!users.length) { document.getElementById('usersTable').innerHTML = '<p style="color:#64748b;text-align:center;padding:30px;">No users found</p>'; return; }
            var html = '<table><thead><tr><th>User</th><th>Email</th><th>Status</th><th>KYC</th><th>Joined</th><th>Action</th></tr></thead><tbody>';
            users.forEach(function(u) {
                var init = (u.first_name || 'U').charAt(0).toUpperCase();
                html += '<tr><td><div class="user-info"><div class="avatar">' + init + '</div><div>' + (u.first_name || '') + ' ' + (u.last_name || '') + '</div></div></td>';
                html += '<td>' + u.email + '</td>';
                html += '<td><span class="badge ' + u.status + '">' + u.status + '</span></td>';
                html += '<td><span class="badge ' + (u.kyc_status || 'pending') + '">' + (u.kyc_status || 'N/A') + '</span></td>';
                html += '<td>' + formatDate(u.created_at) + '</td>';
                html += '<td><button class="btn-sm btn-primary" onclick="viewUser(\'' + u.id + '\')"><i class="fas fa-eye"></i> View</button></td></tr>';
            });
            html += '</tbody></table>';
            document.getElementById('usersTable').innerHTML = html;
        }

        async function viewUser(userId) {
            currentUserId = userId;
            document.getElementById('userModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = '<div class="loading">Loading user details...</div>';
            try {
                var res = await fetch(API + '/admin/users/' + userId, { headers: getHeaders() });
                var data = await res.json();
                if (data.success) { renderUserModal(data.data); } else { throw new Error(data.message); }
            } catch (e) { document.getElementById('modalBody').innerHTML = '<p style="color:#ef4444;">Failed to load user</p>'; }
        }

        function renderUserModal(data) {
            var u = data.user;
            var accounts = data.accounts || [];
            var init = (u.first_name || 'U').charAt(0).toUpperCase();

            var accountsHtml = '';
            if (accounts.length) {
                accounts.forEach(function(a) {
                    accountsHtml += '<div class="account-card">';
                    accountsHtml += '<h4>' + (a.account_name || a.account_type || 'Account') + '</h4>';
                    accountsHtml += '<div class="account-num">Account #' + a.account_number + '</div>';
                    accountsHtml += '<div class="balance">' + formatCurrency(a.cash_balance) + '</div>';
                    accountsHtml += '<div class="meta"><span>Buying Power: ' + formatCurrency(a.buying_power) + '</span><span>Portfolio: ' + formatCurrency(a.portfolio_value) + '</span><span class="badge ' + a.status + '">' + a.status + '</span></div>';
                    accountsHtml += '<div class="credit-debit-box"><h5><i class="fas fa-wallet"></i> Adjust Balance</h5>';
                    accountsHtml += '<div class="input-row"><input type="number" id="amount_' + a.id + '" placeholder="Enter amount" min="0" step="0.01"><input type="text" id="reason_' + a.id + '" placeholder="Reason (optional)"></div>';
                    accountsHtml += '<div class="btn-row"><button class="btn btn-success" onclick="creditAccount(\'' + a.id + '\')"><i class="fas fa-plus"></i> Credit</button>';
                    accountsHtml += '<button class="btn btn-danger" onclick="debitAccount(\'' + a.id + '\', ' + a.cash_balance + ')"><i class="fas fa-minus"></i> Debit</button></div></div>';
                    accountsHtml += '</div>';
                });
            } else {
                accountsHtml = '<p style="color:#64748b;">No accounts found for this user</p>';
            }

            var html = '<div id="alertBox"></div>';
            html += '<div class="user-profile"><div class="avatar-lg">' + init + '</div><div><h4>' + (u.first_name || '') + ' ' + (u.last_name || '') + '</h4><p><i class="fas fa-envelope"></i> ' + u.email + '</p><p><i class="fas fa-calendar"></i> Joined ' + formatDate(u.created_at) + '</p><p><span class="badge ' + u.status + '">' + u.status + '</span></p></div></div>';

            html += '<div class="tabs"><button class="tab active" onclick="switchTab(\'accounts\', this)">Accounts</button><button class="tab" onclick="switchTab(\'profile\', this)">Edit Profile</button><button class="tab" onclick="switchTab(\'kyc\', this)">KYC</button></div>';

            html += '<div class="tab-content active" id="accountsTab">' + accountsHtml + '</div>';

            html += '<div class="tab-content" id="profileTab"><form onsubmit="updateStatus(event)"><div class="form-group"><label>User Status</label><select id="userStatus"><option value="active"' + (u.status === 'active' ? ' selected' : '') + '>Active</option><option value="suspended"' + (u.status === 'suspended' ? ' selected' : '') + '>Suspended</option><option value="closed"' + (u.status === 'closed' ? ' selected' : '') + '>Closed</option></select></div><div class="form-group"><label>Reason</label><textarea id="statusReason" rows="3" placeholder="Reason for status change..."></textarea></div><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Status</button></form></div>';

            html += '<div class="tab-content" id="kycTab"><form onsubmit="updateKYC(event)"><div class="form-row"><div class="form-group"><label>KYC Status</label><select id="kycStatus"><option value="pending"' + (u.kyc_status === 'pending' ? ' selected' : '') + '>Pending</option><option value="under_review"' + (u.kyc_status === 'under_review' ? ' selected' : '') + '>Under Review</option><option value="approved"' + (u.kyc_status === 'approved' ? ' selected' : '') + '>Approved</option><option value="rejected"' + (u.kyc_status === 'rejected' ? ' selected' : '') + '>Rejected</option></select></div><div class="form-group"><label>Verification Level</label><select id="kycLevel"><option value="0">Level 0</option><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option></select></div></div><div class="form-group"><label>Rejection Reason (if rejected)</label><textarea id="kycReason" rows="2" placeholder="Reason..."></textarea></div><button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Update KYC</button></form></div>';

            document.getElementById('modalBody').innerHTML = html;
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function showAlert(msg, type) {
            var box = document.getElementById('alertBox');
            box.innerHTML = '<div class="alert alert-' + type + '">' + msg + '</div>';
            setTimeout(function() { box.innerHTML = ''; }, 4000);
        }

        async function creditAccount(accountId) {
            var amount = document.getElementById('amount_' + accountId).value;
            var reason = document.getElementById('reason_' + accountId).value || 'Admin credit';
            if (!amount || parseFloat(amount) <= 0) { alert('Enter a valid amount'); return; }
            try {
                var res = await fetch(API + '/admin/accounts/' + accountId + '/credit', {
                    method: 'POST', headers: getHeaders(),
                    body: JSON.stringify({ amount: parseFloat(amount), reason: reason })
                });
                var data = await res.json();
                if (data.success) { showAlert('Successfully credited ' + formatCurrency(amount), 'success'); viewUser(currentUserId); }
                else { showAlert(data.message || 'Credit failed', 'error'); }
            } catch (e) { showAlert('Error: ' + e.message, 'error'); }
        }

        async function debitAccount(accountId, currentBal) {
            var amount = document.getElementById('amount_' + accountId).value;
            var reason = document.getElementById('reason_' + accountId).value || 'Admin debit';
            if (!amount || parseFloat(amount) <= 0) { alert('Enter a valid amount'); return; }
            if (parseFloat(amount) > currentBal) { alert('Amount exceeds current balance (' + formatCurrency(currentBal) + ')'); return; }
            try {
                var res = await fetch(API + '/admin/accounts/' + accountId + '/debit', {
                    method: 'POST', headers: getHeaders(),
                    body: JSON.stringify({ amount: parseFloat(amount), reason: reason })
                });
                var data = await res.json();
                if (data.success) { showAlert('Successfully debited ' + formatCurrency(amount), 'success'); viewUser(currentUserId); }
                else { showAlert(data.message || 'Debit failed', 'error'); }
            } catch (e) { showAlert('Error: ' + e.message, 'error'); }
        }

        async function updateStatus(e) {
            e.preventDefault();
            var status = document.getElementById('userStatus').value;
            var reason = document.getElementById('statusReason').value;
            try {
                var res = await fetch(API + '/admin/users/' + currentUserId + '/status', {
                    method: 'PATCH', headers: getHeaders(),
                    body: JSON.stringify({ status: status, reason: reason })
                });
                var data = await res.json();
                if (data.success) { showAlert('Status updated!', 'success'); loadUsers(); }
                else { showAlert(data.message || 'Update failed', 'error'); }
            } catch (e) { showAlert('Error: ' + e.message, 'error'); }
        }

        async function updateKYC(e) {
            e.preventDefault();
            var status = document.getElementById('kycStatus').value;
            var level = document.getElementById('kycLevel').value;
            var reason = document.getElementById('kycReason').value;
            try {
                var res = await fetch(API + '/admin/kyc/' + currentUserId + '/review', {
                    method: 'POST', headers: getHeaders(),
                    body: JSON.stringify({ status: status, verification_level: parseInt(level), rejection_reason: reason })
                });
                var data = await res.json();
                if (data.success) { showAlert('KYC updated!', 'success'); }
                else { showAlert(data.message || 'Update failed', 'error'); }
            } catch (e) { showAlert('Error: ' + e.message, 'error'); }
        }

        function closeModal() { document.getElementById('userModal').classList.remove('active'); currentUserId = null; }

        document.getElementById('userModal').addEventListener('click', function(e) { if (e.target.id === 'userModal') closeModal(); });
        document.getElementById('searchInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') searchUsers(); });

        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            loadUsers();
            var params = new URLSearchParams(window.location.search);
            var userId = params.get('user');
            if (userId) viewUser(userId);
        });
    </script>
</body>
</html>
